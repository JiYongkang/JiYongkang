<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MongoDB 介绍与部署应用</title>
      <link href="/2019/05/25/MongoDB%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/"/>
      <url>/2019/05/25/MongoDB%E4%BB%8B%E7%BB%8D%E4%B8%8E%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="MongoDB-简介"><a href="#MongoDB-简介" class="headerlink" title="MongoDB 简介"></a>MongoDB 简介</h1><ul><li>MongoDB 是由 C++语言编写一个基于分布式文件存储的开源 NoSQL 数据库系统。在高负<br>载的情况下，可添加更多的节点，以保证服务性能。 在许多场景下用于代替传统的关系型<br>数据库或键/值存储方式。旨在为 Web 应用提供可扩展的高性能数据存储解决方案。</li><li>MongoDB 提供了一个面向文档存储，操作起来比较简单和容易，可以存储比较复杂的<br>数据类型。最大的特点是支持的查询语言非常强大，语法优点类似于面向对象的查询语<br>言。几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索<br>引。是一个面向集合的，模式自由的文档型数据库。</li><li>MongoDB 适用领域：<ul><li>网站数据</li><li>分布式场景</li><li>缓存层</li><li>文档格式存储</li></ul></li></ul><h1 id="逻辑结构"><a href="#逻辑结构" class="headerlink" title="逻辑结构"></a>逻辑结构</h1><ul><li>文档（document）：是 mongodb 的核心概念，是 mongodb 逻辑存储的最小单元</li><li>集合（collection）：多个文档组成集合</li><li>数据库（database）：多个集合组成数据库</li></ul><table><thead><tr><th style="text-align:center">MongoDB</th><th style="text-align:center">关系型数据库</th></tr></thead><tbody><tr><td style="text-align:center">文档（document）</td><td style="text-align:center">行（row）</td></tr><tr><td style="text-align:center">集合（collection）</td><td style="text-align:center">表（table）</td></tr><tr><td style="text-align:center">数据库（database）</td><td style="text-align:center">数据库（database）</td></tr></tbody></table><h1 id="物理存储结构"><a href="#物理存储结构" class="headerlink" title="物理存储结构"></a>物理存储结构</h1><h2 id="数据存储结构"><a href="#数据存储结构" class="headerlink" title="数据存储结构"></a>数据存储结构</h2><ul><li>命名空间文件（ns）</li><li>数据文件（0,1,2）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# ll -ht /data/mongodb1/</span><br><span class="line">总用量 81M</span><br><span class="line">drwxr-xr-x 2 root root 4.0K 7 月 11 16:45 diagnostic.data</span><br><span class="line">-rw------- 1 root root 64M 7 月 11 16:32 local.0</span><br><span class="line">-rw------- 1 root root 16M 7 月 11 16:32 local.ns</span><br><span class="line">-rw-r--r-- 1 root root 5 7 月 11 16:32 mongod.lock</span><br><span class="line">drwxr-xr-x 2 root root 4.0K 7 月 11 16:32 journal</span><br><span class="line">-rw-r--r-- 1 root root 69 7 月 11 11:26 storage.bson</span><br></pre></td></tr></table></figure></li></ul><h2 id="日志存储结构"><a href="#日志存储结构" class="headerlink" title="日志存储结构"></a>日志存储结构</h2><ul><li>系统日志文件 logpath</li><li>journal 日志文件</li><li>oplog 复制操作日志文件</li><li>慢查询日志<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# ll -ht /data/logs/mongodb/mongodb1.log</span><br><span class="line">-rwxrwxrwx 1 root root 21K 7 月 11 16:39 /data/logs/mongodb/mongodb1.log</span><br><span class="line">[root@mongodb ~]# ll -ht /data/mongodb1/journal/</span><br><span class="line">总用量 3.1G</span><br><span class="line">-rw------- 1 root root 1.0G 7 月 11 16:32 j._0</span><br><span class="line">-rw------- 1 root root 1.0G 7 月 11 11:26 prealloc.2</span><br><span class="line">-rw------- 1 root root 1.0G 7 月 11 11:26 prealloc.1</span><br></pre></td></tr></table></figure></li></ul><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><ul><li>BSON 是 Binary JSON，是二进制的格式，能将 mongdb 的所有文档表示为字节字符串。</li><li>JSON 是一种轻量级的数据交换格式。它基于 JavaScript 的一个子集</li></ul><h2 id="BSON-的数据类型"><a href="#BSON-的数据类型" class="headerlink" title="BSON 的数据类型"></a>BSON 的数据类型</h2><ul><li>null，代表空或者不存在</li><li>布尔，只有 true 和 false</li><li>数字， 64 位浮点数</li><li>字符串， utf8 字符串</li><li>数组，值或者列表可表示为数组</li><li>对象，对象的数据</li></ul><h2 id="BSON-的特点"><a href="#BSON-的特点" class="headerlink" title="BSON 的特点"></a>BSON 的特点</h2><ul><li>优点：简单，简洁，容易理解、解析、记忆</li></ul><h2 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h2><ul><li>文档的键命名几乎所有 utf8 字符，只有少数例外： $开头； \0（空字符）；_ 下划线开头。</li><li>集合的命名几乎所有 utf8 字符，只有少数例外： $开头； \0（空字符）； system.开头； ”&emsp; ”空字符串。</li><li>数据库的命名几乎所有 utf8 字符，只有少数例外： ”&emsp; ”空字符串；\0；空格； . 点； \ ；/。</li></ul><h1 id="安装与管理-MongoDB"><a href="#安装与管理-MongoDB" class="headerlink" title="安装与管理 MongoDB"></a>安装与管理 MongoDB</h1><ul><li><p>官网下载地址：<a href="http://www.mongodb.org/downloads" target="_blank" rel="noopener">http://www.mongodb.org/downloads</a></p></li><li><p>此次安装版本下载地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# wget https://www.mongodb.com/dr/fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.2.7.tgz/download</span><br></pre></td></tr></table></figure></li><li><p>在CentOS-6.6 64位系统部署</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# tar xf mongodb-linux-x86_64-rhel62-3.2.7.tgz</span><br><span class="line">[root@mongodb ~]# mv mongodb-linux-x86_64-rhel62-3.2.7/ /usr/local/mongodb</span><br></pre></td></tr></table></figure></li><li><p>指定同一时间最多可开启的文件数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# ulimit -n</span><br><span class="line">1024</span><br><span class="line">[root@mongodb ~]# ulimit -n 65535</span><br><span class="line">[root@mongodb ~]# ulimit -n</span><br><span class="line">65535</span><br></pre></td></tr></table></figure></li><li><p>用户最多可开启的程序数目</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# ulimit -u</span><br><span class="line">7758</span><br><span class="line">[root@mongodb ~]# ulimit -u 65535</span><br><span class="line">[root@mongodb ~]# ulimit -u</span><br><span class="line">65535</span><br></pre></td></tr></table></figure></li><li><p>创建数据目录，日志文件及目录并创建相应配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# mkdir -p /data/mongodb1</span><br><span class="line">[root@mongodb ~]# mkdir -p /data/logs/mongodb</span><br><span class="line">[root@mongodb ~]# touch /data/logs/mongodb/mongodb1.log</span><br><span class="line">[root@mongodb ~]# cd /usr/local/mongodb/</span><br><span class="line">[root@mongodb mongodb]# ls</span><br><span class="line">bin GNU-AGPL-3.0 MPL-2 README THIRD-PARTY-NOTICES</span><br><span class="line">[root@mongodb mongodb]# mkdir conf</span><br><span class="line">[root@mongodb mongodb]# vim conf/mongodb1.conf</span><br><span class="line">port=27017</span><br><span class="line">dbpath=/data/mongodb1</span><br><span class="line">logpath=/data/logs/mongodb/mongodb1.log</span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=5000</span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root@mongodb mongodb]# pwd</span><br><span class="line">/usr/local/mongodb</span><br><span class="line">[root@mongodb mongodb]# ls bin/</span><br><span class="line">bsondump mongo mongod mongodump mongoexport mongofiles mongoimport</span><br><span class="line">mongooplog mongoperf mongorestore mongos mongostat mongotop</span><br></pre></td></tr></table></figure></li><li><p>启动 MongoDB 数据库， -f 指定配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb mongodb]# /usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/mongodb1.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 1791</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@mongodb mongodb]# netstat -anpt |grep mongod</span><br><span class="line">tcp 0 0 0.0.0.0:27017 0.0.0.0:* LISTEN  1791/mongod</span><br><span class="line">[root@mongodb mongodb]# ps aux |grep mongdb</span><br><span class="line">root 1347 0.0 0.0 103248 872 pts/0 S+ 11:28 0:00 grep mongdb</span><br></pre></td></tr></table></figure></li><li><p>设置开机自动启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb mongodb]# vim /etc/rc.local</span><br><span class="line">rm -f /data/mongodb1/mongod.lock</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/mongodb1.conf</span><br></pre></td></tr></table></figure></li><li><p>连接数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongo</span><br><span class="line">MongoDB shell version: 3.2.7</span><br><span class="line">connecting to: test</span><br><span class="line">Welcome to the MongoDB shell.</span><br><span class="line">For interactive help, type &quot;help&quot;.</span><br><span class="line">For more comprehensive documentation, see</span><br><span class="line">http://docs.mongodb.org/</span><br><span class="line">Questions? Try the support group</span><br><span class="line">http://groups.google.com/group/mongodb-user</span><br><span class="line">Server has startup warnings:</span><br><span class="line">2016-07-11T11:26:52.060+0800 I CONTROL [initandlisten] ** WARNING: You are running this</span><br><span class="line">process as the root user, which is not recommended.</span><br><span class="line">2016-07-11T11:26:52.061+0800 I CONTROL [initandlisten]</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten]</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">/sys/kernel/mm/transparent_hugepage/enabled is &apos;always&apos;.</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten] ** We suggest setting it</span><br><span class="line">to &apos;never&apos;</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten]</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">/sys/kernel/mm/transparent_hugepage/defrag is &apos;always&apos;.</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten] ** We suggest setting it</span><br><span class="line">to &apos;never&apos;</span><br><span class="line">2016-07-11T11:26:52.107+0800 I CONTROL [initandlisten]</span><br><span class="line">&gt; show dbs</span><br><span class="line">local 0.078GB</span><br><span class="line">&gt; exit</span><br><span class="line">bye</span><br></pre></td></tr></table></figure></li><li><p>去除报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[root@mongodb ~]# echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">[root@mongodb ~]# vim .bash_profile</span><br><span class="line">alias mongo=/usr/local/mongodb/bin/mongo</span><br><span class="line">[root@mongodb ~]# . .bash_profile</span><br></pre></td></tr></table></figure></li><li><p>关闭服务的三种方法</p><ul><li><p>方法一</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# mongo</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.shutdownServer(); //关闭服务</span><br><span class="line">server should be down...</span><br><span class="line">2016-07-11T16:08:20.848+0800 I NETWORK [thread1] trying reconnect to 127.0.0.1:27017</span><br><span class="line">(127.0.0.1) failed</span><br><span class="line">2016-07-11T16:08:20.848+0800 W NETWORK [thread1] Failed to connect to 127.0.0.1:27017,</span><br><span class="line">reason: errno:111 Connection refused</span><br><span class="line">2016-07-11T16:08:20.848+0800 I NETWORK [thread1] reconnect 127.0.0.1:27017 (127.0.0.1)</span><br><span class="line">failed failed</span><br><span class="line">&gt; exit</span><br><span class="line">bye</span><br><span class="line">[root@mongodb ~]# netstat -anpt |grep mongod</span><br></pre></td></tr></table></figure></li><li><p>方法二</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/mongodb1.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 1448</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@mongodb ~]# netstat -anpt |grep mongod</span><br><span class="line">tcp 0 0 0.0.0.0:27017 0.0.0.0:* LISTEN 1448/mongod</span><br><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongod -f</span><br><span class="line">/usr/local/mongodb/conf/mongodb1.conf --shutdown</span><br><span class="line">killing process with pid: 1448</span><br><span class="line">[root@mongodb ~]# netstat -anpt |grep mongod</span><br></pre></td></tr></table></figure></li><li><p>方法三：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# kill 1448 //杀死进程号</span><br><span class="line">[root@mongodb ~]# netstat -anpt |grep mongod</span><br></pre></td></tr></table></figure></li></ul></li><li><p>开启两个实例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# cd /usr/local/mongodb/conf/</span><br><span class="line">[root@mongodb conf]# cp mongodb&#123;1,2&#125;.conf</span><br><span class="line">[root@mongodb conf]# ls</span><br><span class="line">mongodb1.conf mongodb2.conf</span><br><span class="line">[root@mongodb conf]# vim mongodb2.conf</span><br><span class="line">port=27018</span><br><span class="line">dbpath=/data/mongodb2</span><br><span class="line">logpath=/data/logs/mongodb/mongodb2.log</span><br><span class="line">logappend=true</span><br><span class="line">fork=true</span><br><span class="line">maxConns=5000</span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root@mongodb conf]# mkdir /data/mongodb2</span><br><span class="line">[root@mongodb conf]# touch /data/logs/mongodb/mongodb2.log</span><br><span class="line">[root@mongodb conf]# chmod 777 /data/logs/mongodb/mongodb2.log</span><br></pre></td></tr></table></figure></li><li><p>编写启停脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb conf]# cd /etc/init.d/</span><br><span class="line">[root@mongodb init.d]# vim mongodb</span><br><span class="line">#!/bin/bash</span><br><span class="line">INSTANCE=$1</span><br><span class="line">ACTION=$2</span><br><span class="line">case &quot;$ACTION&quot; in</span><br><span class="line">&apos;start&apos;)</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/&quot;$INSTANCE&quot;.conf;;</span><br><span class="line">&apos;stop&apos;)</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/&quot;$INSTANCE&quot;.conf --shutdown;;</span><br><span class="line">&apos;restart&apos;)</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/&quot;$INSTANCE&quot;.conf --shutdown</span><br><span class="line">/usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/&quot;$INSTANCE&quot;.conf;;</span><br><span class="line">esac</span><br><span class="line">[root@mongodb init.d]# chmod +x mongodb</span><br><span class="line">[root@mongodb ~]# /etc/init.d/mongodb mongodb1 start</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 1521</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@mongodb init.d]# /etc/init.d/mongodb mongodb2 start</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 1498</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@mongodb init.d]# netstat -anpt |grep mongod</span><br><span class="line">tcp 0 0 0.0.0.0:27017 0.0.0.0:* LISTEN  1521/mongod</span><br><span class="line">tcp 0 0 0.0.0.0:27018 0.0.0.0:* LISTEN  1498/mongod</span><br></pre></td></tr></table></figure></li></ul><h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><table><thead><tr><th style="text-align:center">操作</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">show dbs</td><td style="text-align:center">查看当前示例下的数据库列表，等同于 show database</td></tr><tr><td style="text-align:center">show users</td><td style="text-align:center">显示用户</td></tr><tr><td style="text-align:center">use &lt;db_name&gt;</td><td style="text-align:center">切换当前数据库</td></tr><tr><td style="text-align:center">db.help()</td><td style="text-align:center">显示数据库操作命令</td></tr><tr><td style="text-align:center">show collections</td><td style="text-align:center">显示当前数据库中的集合，等同于 show tables</td></tr><tr><td style="text-align:center">db.mycoll.help()</td><td style="text-align:center">显示集合操作命令， mycoll 是当前下叫做 mycoll 的集合</td></tr><tr><td style="text-align:center">db.foo.find()</td><td style="text-align:center">对当前数据库中 foo 集合进行数据查找</td></tr><tr><td style="text-align:center">ctrl + d</td><td style="text-align:center">退出</td></tr><tr><td style="text-align:center">help</td><td style="text-align:center">查看帮助</td></tr></tbody></table><h1 id="数据库备份与导入"><a href="#数据库备份与导入" class="headerlink" title="数据库备份与导入"></a>数据库备份与导入</h1><h2 id="数据备份方法"><a href="#数据备份方法" class="headerlink" title="数据备份方法"></a>数据备份方法</h2><ul><li>导入： mongoimport</li><li>导出： mongoexport</li><li>备份<ul><li>逻辑备份： mongodump</li><li>物理备份：冷备</li></ul></li><li>恢复： mongorestore</li></ul><h2 id="复制数据库"><a href="#复制数据库" class="headerlink" title="复制数据库"></a>复制数据库</h2><ul><li>复制本地数据库： db.copyDatabase(“from_db”,”to_db”,”locolhost”)</li><li>复制远程数据库： db.copyDatabase(“from_db”,”to_db”,”192.168.200.101”)</li><li>克隆集合： db.runCommand({cloneCollection:”accp.t1”,from:”192.168.200.101”})</li></ul><h2 id="查看帮助的方法："><a href="#查看帮助的方法：" class="headerlink" title="查看帮助的方法："></a>查看帮助的方法：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongoimport --help</span><br><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongoexport --help</span><br><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongodump --help</span><br></pre></td></tr></table></figure><h2 id="备份案例"><a href="#备份案例" class="headerlink" title="备份案例"></a>备份案例</h2><ul><li><p>将 MySQL 数据库内容导入 mongodb</p><ul><li><p>安装 mysql 数据库，创建一个表并插入一些内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# yum -y install mysql mysql-server</span><br><span class="line">[root@mongodb ~]# /etc/init.d/mysqld start</span><br><span class="line">[root@mongodb ~]# mysql</span><br><span class="line">mysql&gt; create database benet;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; use benet;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table t1(id int,name varchar(20));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line">mysql&gt; insert into t1 values(1,&quot;Jack&quot;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; insert into t1 values(2,&quot;Rose&quot;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+------+------+</span><br><span class="line">| id | name |</span><br><span class="line">+------+------+</span><br><span class="line">| 1 | Jack |</span><br><span class="line">| 2 | Rose |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)21 / 25</span><br><span class="line">mysql&gt; select * from t1 into outfile &apos;/tmp/t1_mysql.csv&apos; fields terminated by &quot;,&quot;;</span><br><span class="line">//导出 t1 表里的内容到/tmp/t1_mysql.csv 文件，以“，”逗号分割</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; Bye</span><br><span class="line">[root@mongodb ~]# cat /tmp/t1_mysql.csv</span><br><span class="line">1,Jack</span><br><span class="line">2,Rose</span><br></pre></td></tr></table></figure></li><li><p>将 csv 格式的表导入 mongodb</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# /usr/local/mongodb/bin/mongoimport -d benet -c tt1 -f id,name --file</span><br><span class="line">/tmp/t1_mysql.csv --type csv</span><br><span class="line">2016-07-11T18:31:23.160+0800 connected to: localhost</span><br><span class="line">2016-07-11T18:31:23.195+0800 imported 2 documents</span><br></pre></td></tr></table></figure></li><li><p>将/tmp/t1_mysql.csv 文件导入到 mongodb 的 benet 数据库下的 tt1 表，字段名称为 id 和name，文件类型为 csv</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# mongo</span><br><span class="line">&gt; use benet</span><br><span class="line">switched to db benet</span><br><span class="line">&gt; show collections</span><br><span class="line">system.indexes</span><br><span class="line">tt1</span><br><span class="line">user</span><br><span class="line">&gt; db.tt1.find();</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5783757b737177ed108eb553&quot;), &quot;id&quot; : 1, &quot;name&quot; : &quot;Jack&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5783757b737177ed108eb554&quot;), &quot;id&quot; : 2, &quot;name&quot; : &quot;Rose&quot; &#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于Dockerfile制作tomcat镜像</title>
      <link href="/2019/05/22/dockerfile/"/>
      <url>/2019/05/22/dockerfile/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-概述："><a href="#Docker-概述：" class="headerlink" title="Docker 概述："></a>Docker 概述：</h2><p>&emsp;&emsp;在前面的例子中，我们从下载镜像，启动容器，在容器中输入命令来运行程序，这些命令都是手工一条条往里输入的，无法重复利用，而且效率很低。所以就需要一种文件或脚本，我们把想执行的操作以命令的方式写入其中，然后让 docker 读取并分析、执行，那么重复构建、更新将变得很方便，所以Dockerfile 就此诞生了</p><h2 id="常用参数："><a href="#常用参数：" class="headerlink" title="常用参数："></a>常用参数：</h2><ul><li>FROM 命令。用法， FROM &lt;image>:&lt;tag>。 FROM 命令告诉 docker 我们构建的镜像是以哪个(发行版)镜像为基础的</li><li>RUN 命令。用法 RUN <command>。 RUN 后面接要执行的命令，比如，我们想在镜像中安装 vim，只需在</li><li>Dockfile 中写入 RUN yum install -y vim</li><li>ENV 命令。用法,ENV <key> <value>。 ENV 命令主要用于设置容器运行时的环境变量</value></key></li><li>ADD 命令。用法， ADD <src> <dest>。 ADD 主要用于将宿主机中的文件添加到镜像中</dest></src></li></ul><h2 id="基于-dockerfile-制作-tomcat-镜像"><a href="#基于-dockerfile-制作-tomcat-镜像" class="headerlink" title="基于 dockerfile 制作 tomcat 镜像"></a>基于 dockerfile 制作 tomcat 镜像</h2><ul><li>首先建一个目录构建我们的环境。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir tomcat_centos</span><br><span class="line">[root@localhost ~]# cd tomcat_centos</span><br></pre></td></tr></table></figure><ul><li>上传 tomcat 和 jdk 到该目录下。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# ls</span><br><span class="line">apache-tomcat-7.0.54.tar.gz jdk-7u65-linux-x64.tar.gz</span><br></pre></td></tr></table></figure><ul><li>编辑 Dockerfile</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# vim Dockerfile</span><br><span class="line">FROM centos:1</span><br><span class="line">MAINTAINER from bistros &lt;bistros@163.com&gt;</span><br><span class="line">#copy jdk and tomcat into image</span><br><span class="line">ADD ./apache-tomcat-7.0.54.tar.gz /root</span><br><span class="line">ADD ./jdk-7u65-linux-x64.tar.gz /root</span><br><span class="line">#set environment variable</span><br><span class="line">ENV JAVA_HOME /root/jdk1.7.0_65</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">#define entry point which will be run first when the container starts up</span><br><span class="line">ENTRYPOINT /root/apache-tomcat-7.0.54/bin/startup.sh &amp;&amp; tail -F /root/apache-tomcat-</span><br><span class="line">7.0.54/logs/catalina.out</span><br></pre></td></tr></table></figure><ul><li>构建镜像</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# docker build -t bistros/tomcat:centos .</span><br><span class="line">Sending build context to Docker daemon 151.3 MB</span><br><span class="line">Step 1 : FROM centos:1</span><br><span class="line">---&gt; 4a7667a30862</span><br><span class="line">Step 2 : MAINTAINER from bistros &lt;bistros@163.com&gt;</span><br><span class="line">---&gt; Running in 68bf1a959d26</span><br><span class="line">---&gt; fcf74efba621</span><br><span class="line">Removing intermediate container 68bf1a959d26</span><br><span class="line">Step 3 : ADD ./apache-tomcat-7.0.54.tar.gz /root</span><br><span class="line">---&gt; 66cddab1de86</span><br><span class="line">Removing intermediate container f0b727f5be51</span><br><span class="line">Step 4 : ADD ./jdk-7u65-linux-x64.tar.gz /root</span><br><span class="line">---&gt; e5bb29fe10f6</span><br><span class="line">Removing intermediate container b26f642c67ac</span><br><span class="line">Step 5 : ENV JAVA_HOME /root/jdk1.7.0_65</span><br><span class="line">---&gt; Running in dfd83d97c8ed</span><br><span class="line">---&gt; e434fbfdf162</span><br><span class="line">Removing intermediate container dfd83d97c8ed</span><br><span class="line">Step 6 : ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line">---&gt; Running in 2233e413bb0d</span><br><span class="line">---&gt; 6a2c544ad3c2</span><br><span class="line">Removing intermediate container 2233e413bb0d</span><br><span class="line">Step 7 : ENTRYPOINT /root/apache-tomcat-7.0.54/bin/startup.sh &amp;&amp; tail -F /root/apache-tomcat-</span><br><span class="line">7.0.54/logs/catalina.out</span><br><span class="line">---&gt; Running in 8d58b19e8ad7</span><br><span class="line">---&gt; c0c55ad98c79</span><br><span class="line">Removing intermediate container 8d58b19e8ad7</span><br><span class="line">Successfully built c0c55ad98c79</span><br></pre></td></tr></table></figure><ul><li>-t 选择指定生成镜像的用户名，仓库名和 tag</li><li>–rm=true 指定在生成镜像过程中删除中间产生的临时容器。</li></ul><h2 id="查看新产生的镜像"><a href="#查看新产生的镜像" class="headerlink" title="查看新产生的镜像"></a>查看新产生的镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# docker images bistros/tomcat:centos</span><br><span class="line">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br><span class="line">bistros/tomcat centos c0c55ad98c79 About a minute ago 502.7 MB</span><br></pre></td></tr></table></figure><h2 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h2><ul><li>手动映射主机端口启动</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# docker run -d -p 8090:8080 bistros/tomcat:centos</span><br><span class="line">65a0f0910f174132e009ca686b283c0dc58df0dd3000c144cd4c175f2078de37</span><br><span class="line">[root@localhost tomcat_centos]# docker ps -a</span><br><span class="line">CONTAINER ID IMAGE COMMAND</span><br><span class="line">CREATED STATUS PORTS</span><br><span class="line">NAMES5 / 5</span><br><span class="line">65a0f0910f17 bistros/tomcat:centos &quot;/bin/sh -c &apos;/root/ap&quot; 50 seconds ago</span><br><span class="line">Up 48 seconds 0.0.0.0:8090-&gt;8080/tcp pensive_kare</span><br></pre></td></tr></table></figure><ul><li>-p 指定主机 80 端口与容器 8080 端口进行绑定</li><li>-d 指定容器运行后与当前 tty 分离，后台运行</li><li>65a0 是镜像的 ID 前 4 位。<br></li></ul><p>通过 http://宿主机 IP:8090,即可看见我们熟悉的 tomcat 首页了。</p><ul><li>自动映射主机端口的启动</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tomcat_centos]# docker run -d -p 8080 --name tomcat</span><br><span class="line">bistros/tomcat:centos</span><br><span class="line">2f20477608f8d335a3424acd6f54ad5900db86bdbf48af2ea2777159a7646566</span><br><span class="line">[root@localhost tomcat_centos]# docker ps -a</span><br><span class="line">CONTAINER ID IMAGE COMMAND</span><br><span class="line">CREATED STATUS PORTS</span><br><span class="line">NAMES</span><br><span class="line">2f20477608f8 bistros/tomcat:centos &quot;/bin/sh -c &apos;/root/ap&quot; 8 seconds ago</span><br><span class="line">Up 6 seconds 0.0.0.0:32768-&gt;8080/tcp tomcat</span><br></pre></td></tr></table></figure><p>这样就要通过 http://宿主机 IP:32768 访问了。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rsync远程同步</title>
      <link href="/2019/05/22/rsync/"/>
      <url>/2019/05/22/rsync/</url>
      
        <content type="html"><![CDATA[<h2 id="关于rsync"><a href="#关于rsync" class="headerlink" title="关于rsync"></a>关于rsync</h2><ul><li>一款快速增量备份工具<ul><li>Remote Sync，远程同步</li><li>支持本地复制，或者与其他SSH、rsync主机同步</li><li>官方网站：<a href="http://rsync.samba.org/" target="_blank" rel="noopener">http://rsync.samba.org/</a></li></ul></li><li>rsync同步源<ul><li>指备份操作的远程服务器，也称为备份源</li></ul></li><li>基本思路<ul><li>建立rsyncd.conf配置文件、独立的账号文件</li><li>启用rsync的–daemon模式</li></ul></li></ul><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><ul><li>深圳、北京各一台Web服务器</li><li>两台服务器的文档保持一致</li></ul><p><img src="/images/rsync1.png" alt="rsync1"></p><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ul><li>服务器A（北京）作为rsync发起端(192.168.22.186)</li><li>服务器B（深圳）作为远程rsync服务器(192.168.22.187)</li><li>结合inotify机制实现触发式的上行同步</li></ul><h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ul><li>在服务器B中配置rsync备份源</li><li>在服务器A中发起rsync上行同步</li><li>将rsync与inotify-tools工具结合使用</li></ul><h2 id="应用示例"><a href="#应用示例" class="headerlink" title="应用示例"></a>应用示例</h2><ul><li>用户backuper，允许下行同步</li><li><p>操作的目录为 /var/www/html/</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# mkdir -pv /var/www/html</span><br></pre></td></tr></table></figure></li><li><p>配置文件rsyncd.conf<br>需手动建立，语法类似于Samba配置<br>认证配置auth users、secrets file，不加则为匿名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# vi /etc/rsyncd.conf</span><br><span class="line">uid = nobody</span><br><span class="line">gid = nobody</span><br><span class="line">use chroot = yes</span><br><span class="line">address = 192.168.22.186</span><br><span class="line">port 873</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">hosts allow = 192.168.22.0/24</span><br><span class="line">[wwwroot] //共享模块名称</span><br><span class="line">    path = /var/www/html</span><br><span class="line">    comment = Document Root of www1.benet.com</span><br><span class="line">    read only = yes</span><br><span class="line">    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z</span><br><span class="line">    auth users = backuper</span><br><span class="line">    secrets file = /etc/rsyncd_users.db</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li>rsync账号文件<br>采用“用户名:密码”的记录格式<br>独立的账号数据，不依赖于系统账号<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# vi /etc/rsyncd_users.db</span><br><span class="line">backuper:123</span><br><span class="line">[root@186 ~]# chmod 600 /etc/rsyncd_users.db</span><br></pre></td></tr></table></figure></li></ul><p>注意：上行必须执行，否则后面的服务启动后，密码验证将失败！！！！</p><ul><li>启用rsync服务</li></ul><p>通过–daemon独自提供服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# rsync --daemon \\启动rsync服务</span><br><span class="line">[root@186 ~]# netstat -anpt |grep rsync   </span><br><span class="line">tcp        0      0 192.168.22.186:873          0.0.0.0:*                   LISTEN      3190/rsync</span><br><span class="line">[root@186 ~]# cat /var/run/rsyncd.pid</span><br><span class="line">3190</span><br><span class="line">[root@186 ~]# kill $(cat /var/run/rsyncd.pid)  \\结束rsync服务</span><br><span class="line">[root@186 ~]# netstat -anpt |grep rsync</span><br><span class="line">[root@186 ~]#</span><br><span class="line">[root@186 ~]# rsync --daemon</span><br><span class="line">[root@186 ~]# netstat -anpt |grep rsync</span><br><span class="line">tcp        0      0 192.168.22.186:873          0.0.0.0:*                   LISTEN      3271/rsync</span><br></pre></td></tr></table></figure></p><ul><li><p>rsync命令的用法</p><ul><li>基本格式：rsync [选项] 原始位置 目标位置</li><li>常用选项：<ul><li>-a：归档模式，递归并保留对象属性，等同于 -rlptgoD</li><li>-v：显示同步过程的详细（verbose）信息</li><li>-z：在传输文件时进行压缩（compress）</li><li>-H：保留硬连接文件</li><li>-A：保留ACL属性信息</li><li>–delete：删除目标位置有而原始位置没有的文件</li><li>–checksum：根据对象的校验和来决定是否跳过文件</li></ul></li><li>其中：<ul><li>-a：归档模式，递归并保留对象属性，等同于 -rlptgoD</li><li>-r：递归模式，包含目录及子目录中所有文件</li><li>-l：对于符号链接文件仍然复制为符号链接文件</li><li>-p：保留文件的权限标记</li><li>-t：保留文件的时间标记</li><li>-g：保留文件的属组标记（仅超级用户使用）</li><li>-o：保留文件的属主标记（仅超级用户使用）</li><li>-D：保留设备文件及其他特殊文件</li></ul></li></ul></li><li><p>配置源的两种表示方法</p><ul><li>用户名@主机地址::共享模块名</li><li>rsync://用户名@主机地址/共享模块名</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# touch /var/www/html/file&#123;1..10&#125;</span><br><span class="line">[root@186 ~]# ls /var/www/html/</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9</span><br><span class="line"></span><br><span class="line">[root@187 ~]# mkdir /test</span><br><span class="line">[root@187 ~]# rsync -avz backuper@192.168.22.186::wwwroot /test</span><br><span class="line">Password:</span><br><span class="line">receiving incremental file list</span><br><span class="line">./</span><br><span class="line">file1</span><br><span class="line">file10</span><br><span class="line">file2</span><br><span class="line">file3</span><br><span class="line">file4</span><br><span class="line">file5</span><br><span class="line">file6</span><br><span class="line">file7</span><br><span class="line">file8</span><br><span class="line">file9</span><br><span class="line"></span><br><span class="line">sent 254 bytes  received 535 bytes  105.20 bytes/sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br><span class="line">[root@187 ~]# ls /test/</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9</span><br><span class="line">[root@186 ~]# echo &quot;aaaaa&quot; &gt; /var/www/html/file1</span><br><span class="line">[root@187 ~]# rsync -avz backuper@192.168.22.186::wwwroot /test</span><br><span class="line">Password:</span><br><span class="line">receiving incremental file list</span><br><span class="line">file1</span><br><span class="line"></span><br><span class="line">sent 80 bytes  received 225 bytes  122.00 bytes/sec</span><br><span class="line">total size is 6  speedup is 0.02</span><br><span class="line">[root@187 ~]# cat /test/file1</span><br><span class="line">aaaaa</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">[root@187 ~]# rm -rf /test/*</span><br><span class="line">[root@187 ~]# rsync -avz rsync://backuper@192.168.22.186/wwwroot /test/</span><br><span class="line">Password:</span><br><span class="line">receiving incremental file list</span><br><span class="line">./</span><br><span class="line">file1</span><br><span class="line">file10</span><br><span class="line">file2</span><br><span class="line">file3</span><br><span class="line">file4</span><br><span class="line">file5</span><br><span class="line">file6</span><br><span class="line">file7</span><br><span class="line">file8</span><br><span class="line">file9</span><br><span class="line"></span><br><span class="line">sent 254 bytes  received 552 bytes  230.29 bytes/sec</span><br><span class="line">total size is 6  speedup is 0.01</span><br><span class="line">[root@187 ~]# ls /test/</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">[root@187 ~]# touch /test/abc&#123;a..d&#125;</span><br><span class="line">[root@187 ~]# rsync -avz --delete rsync://backuper@192.168.22.186/wwwroot /test/    //--delete：删除目标位置有而原始位置没有的文件</span><br><span class="line">Password:</span><br><span class="line">receiving incremental file list</span><br><span class="line">deleting abcd</span><br><span class="line">deleting abcc</span><br><span class="line">deleting abcb</span><br><span class="line">deleting abca</span><br><span class="line">./</span><br><span class="line"></span><br><span class="line">sent 64 bytes  received 183 bytes  70.57 bytes/sec</span><br><span class="line">total size is 6  speedup is 0.02</span><br><span class="line">[root@187 ~]# ls /test/</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9</span><br></pre></td></tr></table></figure><ul><li>rsync源的免交互处理<ul><li>使用 –password-file= 密码文件</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@187 ~]# vi /etc/server.pass</span><br><span class="line">123</span><br><span class="line">[root@187 ~]# chmod 600 /etc/server.pass</span><br><span class="line">[root@187 ~]# touch /test/file&#123;100..105&#125;.txt</span><br><span class="line">[root@187 ~]# /usr/bin/rsync -az --delete --password-file=/etc/server.pass backuper@192.168.22.186::wwwroot /test/</span><br><span class="line">[root@187 ~]# ls /test/</span><br><span class="line">file1  file10  file2  file3  file4  file5  file6  file7  file8  file9</span><br><span class="line">[root@187 ~]# crontab -e</span><br><span class="line">30      22      *       *       *       /usr/bin/rsync -az --delete --password-file=/etc/server.pass backuper@192.168.22.186::wwwroot /test/</span><br><span class="line"></span><br><span class="line">[root@187 ~]# /etc/init.d/crond status</span><br><span class="line">crond (pid  2069) 正在运行...</span><br><span class="line">[root@187 ~]# chkconfig --list crond</span><br><span class="line">crond          0:关闭1:关闭2:启用3:启用4:启用5:启用6:关闭</span><br></pre></td></tr></table></figure><ul><li>rsync实时同步<ul><li>定期同步的不足</li><li>执行备份的时间固定，延迟明显、实时性差</li><li>当同步源长期不变化时，密集的定期任务是不必要的</li><li>实时同步的优点</li><li>一旦同步源出现变化，立即启动备份</li><li>只要同步源无变化，则不执行备份</li><li>Linux内核的inotify机制</li><li>从版本2.6.13开始提供</li><li>可以监控文件系统的变动情况，并作出通知响应</li><li>辅助软件：inotify-tools</li></ul></li></ul><p><img src="/images/rsync2.png" alt="rsync2"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@186 ~]# chown nobody:nobody /var/www/html</span><br><span class="line">[root@186 ~]# vi /etc/rsyncd.conf</span><br><span class="line">uid = nobody</span><br><span class="line">gid = nobody</span><br><span class="line">use chroot = yes</span><br><span class="line">address = 192.168.22.186</span><br><span class="line">port 873</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">hosts allow = 192.168.22.0/24</span><br><span class="line">[wwwroot]</span><br><span class="line">    path = /var/www/html</span><br><span class="line">    comment = Document Root of www1.benet.com</span><br><span class="line">    read only = no  \\修改此处由yes改为no,以便服务器有写入权限。</span><br><span class="line">    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z</span><br><span class="line">    auth users = backuper</span><br><span class="line">    secrets file = /etc/rsyncd_users.db</span><br><span class="line"></span><br><span class="line">[root@186 ~]# kill $(cat /var/run/rsyncd.pid)</span><br><span class="line">[root@186 ~]# rsync --daemon</span><br></pre></td></tr></table></figure><ul><li>调整inotify内核参数<ul><li>max_queue_events：监控队列大小</li><li>max_user_instances：最多监控实例数</li><li>max_user_watches：每个实例最多监控文件数</li></ul></li></ul><p>========================下面在187客户端上的操作==============</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@187 ~]# vi /etc/sysctl.conf</span><br><span class="line">...</span><br><span class="line">fs.inotify.max_queued_events = 16384</span><br><span class="line">fs.inotify.max_user_instances = 1024</span><br><span class="line">fs.inotify.max_user_watches = 1048576</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@187 ~]# sysctl -p //使本文立即生效</span><br></pre></td></tr></table></figure><p>下面，将软件inotify-tools-3.14.tar.gz上传187客户端中</p><ul><li>安装inotify-tools辅助工具<ul><li>inotifywait：用于持续监控，实时输出结果</li><li>inotifywatch：用于短期监控，任务完成后再出结果</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@187 ~]# tar xf inotify-tools-3.14.tar.gz</span><br><span class="line">[root@187 ~]# cd inotify-tools-3.14</span><br><span class="line">[root@187 inotify-tools-3.14]# ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">[root@187 ~]# mkdir -pv /var/www/html</span><br><span class="line">[root@187 ~]# echo &quot;www.benet.com&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@187 ~]# inotifywait -mrq -e modify,create,move,delete /var/www/html</span><br><span class="line">/var/www/html/ MODIFY index.html</span><br><span class="line">/var/www/html/ CREATE nihao</span><br><span class="line">/var/www/html/ DELETE nihao</span><br><span class="line">/var/www/html/ MOVED_FROM index.html</span><br><span class="line">/var/www/html/ MOVED_TO index.htm</span><br></pre></td></tr></table></figure><p>在另一个187客户机的ssh通道中的操作，会出现以上内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@187 ~]# echo &quot;www.accp.com&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@187 ~]# cd /var/www/html/</span><br><span class="line">[root@187 html]# touch nihao</span><br><span class="line">[root@187 html]# rm -rf nihao</span><br><span class="line">[root@187 html]# mv index.html index.htm</span><br><span class="line">[root@187 html]#</span><br></pre></td></tr></table></figure><ul><li>通过inotifywait触发rsync同步操作<ul><li>使用while、read持续获取监控结果</li><li>根据结果可以作进一步判断，决定执行何种操作</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@187 ~]# vi /opt/inotify_rsync.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#abc</span><br><span class="line">INOTIFY_CMD=&quot;/usr/local/bin/inotifywait -mrq -e modify,create,attrib,move,delete /var/www/html/&quot;</span><br><span class="line">RSYNC_CMD=&quot;/usr/bin/rsync -azH --delete --password-file=/etc/server.pass /var/www/html/ backuper@192.168.22.186::wwwroot&quot;</span><br><span class="line">$INOTIFY_CMD | while read DIRECTORY EVENT FILE</span><br><span class="line">do</span><br><span class="line">    if [ $(pgrep rsync | wc -l) -le 0 ] ; then</span><br><span class="line">        $RSYNC_CMD</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@187 ~]# chmod +x /opt/inotify_rsync.sh</span><br><span class="line">[root@187 ~]# nohup /bin/bash /opt/inotify_rsync.sh &amp;</span><br><span class="line">//注意：nohup 可以保证当前执行程序的用户登出当前系统后，当前程序不停止，仍然执行后台程序。</span><br></pre></td></tr></table></figure><h2 id="实验效果："><a href="#实验效果：" class="headerlink" title="实验效果："></a>实验效果：</h2><p>在187 /var/www/html下随意增删改文件，186下的/var/www/html/下会实时同步。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rsync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三层交换机配置DHCP为不同VLAN分配IP地址</title>
      <link href="/2019/05/18/%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2DHCP/"/>
      <url>/2019/05/18/%E4%B8%89%E5%B1%82%E4%BA%A4%E6%8D%A2DHCP/</url>
      
        <content type="html"><![CDATA[<p>三层交换的原理以及DHCP的原理，作者在这里就不详细的解释了，在这里通过一个案例来了解使用三层交换做DHCP服务器，并为不同网段分配IP地址。在生产环境中，使用路由器或交换机做DHCP服务器要常见一些。</p><h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><p>1、在SW1上配置DHCP服务，能够为以下四个不同部门分配不同网段的IP地址。<br>2、在SW1上配置VTP Server，在SW2和SW3上配置VTP Client，并将指定部门加入相关VLAN。<br>3、注意：交换机和交换机之间使用中继链路，而与路由器之间则不需要</p><h1 id="R1配置如下："><a href="#R1配置如下：" class="headerlink" title="R1配置如下："></a>R1配置如下：</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#配置路由器内网接口IP和外网接口IP</span><br><span class="line">R1(config)#int f0/0</span><br><span class="line">R1(config-if)#ip add 10.0.0.2 255.0.0.0</span><br><span class="line">R1(config-if)#no sh</span><br><span class="line">R1(config-if)#no shutdown</span><br><span class="line">R1(config-if)#exit</span><br><span class="line">R1(config)#int f1/0</span><br><span class="line">R1(config-if)#ip add 202.106.123.1 255.255.255.248</span><br><span class="line">R1(config-if)#no sh</span><br><span class="line">R1(config-if)#no shutdown</span><br><span class="line">#配置到内网的静态路由条目</span><br><span class="line">R1(config)#ip route 192.168.1.0 255.255.255.0 10.0.0.1</span><br><span class="line">R1(config)#ip route 192.168.2.0 255.255.255.0 10.0.0.1</span><br><span class="line">R1(config)#ip route 192.168.3.0 255.255.255.0 10.0.0.1</span><br><span class="line">R1(config)#ip route 192.168.4.0 255.255.255.0 10.0.0.1</span><br></pre></td></tr></table></figure><h1 id="SW1配置如下"><a href="#SW1配置如下" class="headerlink" title="SW1配置如下"></a>SW1配置如下</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#配置到路由器接口的IP地址</span><br><span class="line">SW1(config)#ip routing</span><br><span class="line">SW1(config)#int f0/0</span><br><span class="line">SW1(config-if)#no switchport</span><br><span class="line">SW1(config-if)#ip add 10.0.0.1 255.0.0.0</span><br><span class="line">SW1(config-if)#no shutdown</span><br><span class="line">#配置交换机之间的接口链路为中继链路(trunk)</span><br><span class="line">SW1(config)#int range f0/1 -2</span><br><span class="line">SW1(config-if-range)#switchport mode trunk</span><br><span class="line">SW1(config-if-range)#no sh</span><br><span class="line">#配置VTP Server</span><br><span class="line">SW1#vlan database</span><br><span class="line">SW1(vlan)#vtp domain test</span><br><span class="line">SW1(vlan)#vtp server</span><br><span class="line">SW1(vlan)#vtp password 123</span><br><span class="line">SW1(vlan)#vtp pruning</span><br><span class="line">#创建vlan(为四个部门创建不同的vlan)</span><br><span class="line">SW1#vlan database</span><br><span class="line">SW1(vlan)#vlan 10</span><br><span class="line">SW1(vlan)#vlan 20</span><br><span class="line">SW1(vlan)#vlan 30</span><br><span class="line">SW1(vlan)#vlan 40</span><br><span class="line">#配置vlan虚拟接口地址</span><br><span class="line">SW1(config-if)#intvlan 10</span><br><span class="line">SW1(config-if)#ip add 192.168.1.1 255.255.255.0</span><br><span class="line">SW1(config-if)#no sh</span><br><span class="line">SW1(config-if)#exit</span><br><span class="line">SW1(config-if)#intvlan 20</span><br><span class="line">SW1(config-if)#ip add 192.168.2.1 255.255.255.0</span><br><span class="line">SW1(config-if)#no sh</span><br><span class="line">SW1(config-if)#exit</span><br><span class="line">SW1(config-if)#intvlan 30</span><br><span class="line">SW1(config-if)#ip add 192.168.3.1 255.255.255.0</span><br><span class="line">SW1(config-if)#no sh</span><br><span class="line">SW1(config-if)#exit</span><br><span class="line">SW1(config-if)#intvlan 40</span><br><span class="line">SW1(config-if)#ip add 192.168.4.1 255.255.255.0</span><br><span class="line">SW1(config-if)#no sh</span><br><span class="line">#注意：如果要配置DHCP中继服务，需要在vlan虚接口中添加一条DHCP服务器的地址SW1(config-if)#ip helper-address [DHCP服务器地址]</span><br><span class="line">#配置一条默认路由，使能够访问外网</span><br><span class="line">SW1(config)#ip route 0.0.0.0 0.0.0.0 10.0.0.2</span><br><span class="line">#配置不同网段的DHCP地址池(因为有四个vlan，所以要配四个网段地址池)</span><br><span class="line">SW1(config)#ipdhcp pool vlan10</span><br><span class="line">SW1(dhcp-config)#network 192.168.1.0 255.255.255.0</span><br><span class="line">SW1(dhcp-config)#default-router 192.168.1.1</span><br><span class="line">SW1(dhcp-config)#dns-server 202.106.0.20</span><br><span class="line">SW1(dhcp-config)#lease 2</span><br><span class="line">SW1(dhcp-config)#exit</span><br><span class="line">SW1(config)#ipdhcp pool vlan20</span><br><span class="line">SW1(dhcp-config)#network 192.168.2.0 255.255.255.0</span><br><span class="line">SW1(dhcp-config)#default-router 192.168.2.1</span><br><span class="line">SW1(dhcp-config)#dns-server 202.106.0.20</span><br><span class="line">SW1(dhcp-config)#lease 2</span><br><span class="line">SW1(dhcp-config)#exit</span><br><span class="line">SW1(config)#ipdhcp pool vlan30</span><br><span class="line">SW1(dhcp-config)#network 192.168.3.0 255.255.255.0</span><br><span class="line">SW1(dhcp-config)#default-router 192.168.3.1</span><br><span class="line">SW1(dhcp-config)#dns-server 202.106.0.20</span><br><span class="line">SW1(dhcp-config)#lease 2</span><br><span class="line">SW1(dhcp-config)#exit</span><br><span class="line">SW1(config)#ipdhcp pool vlan40</span><br><span class="line">SW1(dhcp-config)#network 192.168.4.0 255.255.255.0</span><br><span class="line">SW1(dhcp-config)#default-router 192.168.4.1</span><br><span class="line">SW1(dhcp-config)#dns-server 202.106.0.20</span><br><span class="line">SW1(dhcp-config)#lease 2</span><br><span class="line">#注意：如果要设置保留地址可以配置ipdhcp excluded-address low-address [high-address]</span><br></pre></td></tr></table></figure><h1 id="SW2配置如下"><a href="#SW2配置如下" class="headerlink" title="SW2配置如下"></a>SW2配置如下</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#配置与三层交换的链路为中继链路(trunk)</span><br><span class="line">SW2(config)#int f0/0</span><br><span class="line">SW2(config-if)#switchport mode trunk</span><br><span class="line">SW2(config-if)#no sh</span><br><span class="line">#配置VTP client(配置完VTP client后能够学习三层交换上创建的vlan)</span><br><span class="line">SW2#vlan database</span><br><span class="line">SW2(vlan)#vtp domain test</span><br><span class="line">SW2(vlan)#vtp client</span><br><span class="line">SW2(vlan)#vtp password 123</span><br><span class="line">SW2(vlan)#vtp pruning</span><br><span class="line">#将指定的接口加入到相应的vlan中</span><br><span class="line">SW2(config)#int f0/1</span><br><span class="line">SW2(config-if)#switchport access vlan 10</span><br><span class="line">SW2(config-if)#no sh</span><br><span class="line">SW2(config-if)#exit</span><br><span class="line">SW2(config-if)#int f0/2</span><br><span class="line">SW2(config-if)#switchport access vlan 20</span><br><span class="line">SW2(config-if)#no sh</span><br></pre></td></tr></table></figure><h1 id="SW3配置如下"><a href="#SW3配置如下" class="headerlink" title="SW3配置如下"></a>SW3配置如下</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#配置与三层交换的链路为中继链路(trunk)</span><br><span class="line">SW3(config)#int f0/0</span><br><span class="line">SW3(config-if)#switchport mode trunk</span><br><span class="line">SW3(config-if)#no sh</span><br><span class="line">#配置VTP client(配置完VTP client后能够学习三层交换上创建的vlan)</span><br><span class="line">SW3#vlan database</span><br><span class="line">SW3(vlan)#vtp domain test</span><br><span class="line">SW3(vlan)#vtp client</span><br><span class="line">SW3(vlan)#vtp password 123</span><br><span class="line">SW3(vlan)#vtp pruning</span><br><span class="line">#将指定的接口加入到相应的vlan中</span><br><span class="line">SW3(config)#int f0/1</span><br><span class="line">SW3(config-if)#switchport access vlan 30</span><br><span class="line">SW3(config-if)#no sh</span><br><span class="line">SW3(config-if)#exit</span><br><span class="line">SW3(config-if)#int f0/2</span><br><span class="line">SW3(config-if)#switchport access vlan 40</span><br><span class="line">SW3(config-if)#no sh</span><br></pre></td></tr></table></figure><p>配置完以上的所有配置后，在客户端将IP地址设置为DHCP自动获取，就可以获取相应的IP了，并且可以访问互联网了</p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DHCP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PPTP搭建</title>
      <link href="/2019/05/15/PPTP%E6%90%AD%E5%BB%BA/"/>
      <url>/2019/05/15/PPTP%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="1-你所需要的软件"><a href="#1-你所需要的软件" class="headerlink" title="1.你所需要的软件"></a>1.你所需要的软件</h1><p>pppd    ppp拨号服务器<br>pptpd   在pppd拨号的基础上增加pptpd的支持</p><h1 id="2-确定你的内核是否支持mppe"><a href="#2-确定你的内核是否支持mppe" class="headerlink" title="2. 确定你的内核是否支持mppe"></a>2. 确定你的内核是否支持mppe</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe ppp-compress-18 &amp;&amp; echo ok</span><br></pre></td></tr></table></figure><p>如果显示ok，那么恭喜，你的内核已经具备了mppe支持。请到第4部分</p><h1 id="3-升级内核支持mppe"><a href="#3-升级内核支持mppe" class="headerlink" title="3. 升级内核支持mppe"></a>3. 升级内核支持mppe</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://poptop.sourceforge.net/yum/stable/packages/dkms-2.0.17.5-1.noarch.rpm</span><br><span class="line">wget http://poptop.sourceforge.net/yum/stable/packages/kernel_ppp_mppe-1.0.2-3dkms.noarch.rpm</span><br></pre></td></tr></table></figure><p>dkms是一个新的软件，能让你在不编译内核的基础上，外挂一些内核的模块。<br>kernel_ppp_mppe就是mppe支持的内核模块了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh dkms-2.0.17.5-1.noarch.rpm</span><br><span class="line">rpm -ivh kernel_ppp_mppe-1.0.2-3dkms.noarch.rpm</span><br></pre></td></tr></table></figure></p><p>以上二个是为CENTOS加载MPPE[MICROSOFT的加密协议] ..不安装的话就不能使用加密连接<br>ok后重起你的系统</p><h1 id="4-安装ppp"><a href="#4-安装ppp" class="headerlink" title="4. 安装ppp"></a>4. 安装ppp</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install ppp</span><br><span class="line">或者</span><br><span class="line">rpm －Uvh  ppp-2.4.2-b3.i386.rpm</span><br></pre></td></tr></table></figure><p><eg></eg></p><h1 id="5-安装pptpd"><a href="#5-安装pptpd" class="headerlink" title="5. 安装pptpd"></a>5. 安装pptpd</h1><p>(1)使用yum安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/Doylenet.repo</span><br><span class="line">    [doylenet]</span><br><span class="line">    name=Doylenet custom repository for CentOS</span><br><span class="line">    baseurl=http://files.doylenet.net/linux/yum/centos/5/i386/doylenet/</span><br><span class="line">    gpgcheck=1</span><br><span class="line">    gpgkey=http://files.doylenet.net/linux/yum/centos/RPM-GPG-KEY-rdoyle</span><br><span class="line">    enabled=1</span><br><span class="line">    # yum update</span><br><span class="line">    # yum install pptpd</span><br></pre></td></tr></table></figure></p><p>(2)rpm下载安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.ntua.gr/pub/net/poptop/pptpd/pptpd-1.3.1/pptpd-1.1.3-4.i386.rpm</span><br><span class="line">rpm －ivh  pptpd-1.1.3-4.i386.rpm</span><br></pre></td></tr></table></figure></p><p>注意32位或者64位版本，否则吃大亏！鄙人就是在64位服务器上装了32位的pptpd，就给搞了很长时间才发现！！ </p><h1 id="6-配置你的pppd和pptpd"><a href="#6-配置你的pppd和pptpd" class="headerlink" title="6. 配置你的pppd和pptpd"></a>6. 配置你的pppd和pptpd</h1><p>/etc/pptpd.conf中需要配置的地方只有几个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option /etc/ppp/options.pptpd</span><br></pre></td></tr></table></figure></p><p>logwtmp 如果日志里出现类似以下问题一定要注释掉logwtmp！！！！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Jun 21 15:39:55 center pppd[1374]: /usr/lib/pptpd/pptpd-logwtmp.so: wrong ELF class: ELFCLASS32</span><br><span class="line">Jun 21 15:39:55 center pppd[1374]: Couldn&apos;t load plugin /usr/lib/pptpd/pptpd-logwtmp.so</span><br><span class="line">localip 192.168.9.1</span><br><span class="line">remoteip 192.168.9.11-30</span><br></pre></td></tr></table></figure></p><p>配置pptpd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/etc/ppp/options.pptpd</span><br><span class="line">    name pptpd</span><br><span class="line">    refuse-pap</span><br><span class="line">    refuse-chap</span><br><span class="line">    refuse-mschap</span><br><span class="line">    require-mschap-v2</span><br><span class="line">    require-mppe-128</span><br><span class="line">    proxyarp</span><br><span class="line">    lock</span><br><span class="line">    nobsdcomp</span><br><span class="line">    novj</span><br><span class="line">    novjccomp</span><br><span class="line">    nologfd</span><br><span class="line">    idle 2592000</span><br><span class="line">    ms-dns 8.8.8.8</span><br><span class="line">    ms-dns 8.8.4.4</span><br></pre></td></tr></table></figure></p><p>编辑 /etc/ppp/chap-secrets<br>添加一个测试用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/ppp/chap-secrets</span><br><span class="line"># Secrets for authentication using CHAP</span><br><span class="line"># client     server   secret      IP addresses</span><br><span class="line">test      pptpd    test           *</span><br></pre></td></tr></table></figure></p><p>第一个test是用户，第二个test是密码 ，*表示任意ip<br>配置文件/etc/sysctl.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1      修改为“1”内容开启ip转发：</span><br></pre></td></tr></table></figure></p><p>保存、退出后执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p><p><eg></eg></p><h1 id="7-打开防火墙端口"><a href="#7-打开防火墙端口" class="headerlink" title="7. 打开防火墙端口"></a>7. 打开防火墙端口</h1><p>将Linux服务器的1723端口和47端口打开，并打开GRE协议。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 1723 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 47 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p gre -j ACCEPT</span><br><span class="line">iptables -A POSTROUTING -t nat -s 192.168.9.0/24 -o eth0 -j MASQUERADE</span><br><span class="line">iptables -A INPUT -p UDP --dport 53 -j ACCEPT</span><br></pre></td></tr></table></figure></p><p>这个最蛋疼，开始没注意，能连接上怎么都打不开网页，搞了半天才发现DNS端口没有打开，差点昏死过去！！<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure></p><p><eg></eg></p><h1 id="8-测试pptpd"><a href="#8-测试pptpd" class="headerlink" title="8. 测试pptpd"></a>8. 测试pptpd</h1><p>如果是默认安装，你在任意路径打pptpd就可以了。<br>如果成功，用以下命令看到日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tail /var/log/messages</span><br><span class="line">   Feb 10 09:51:46 kdfng pptpd[926]: MGR: Manager process started</span><br><span class="line">   Feb 10 09:51:46 kdfng pptpd[926]: MGR: Maximum of 100 connections available</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
